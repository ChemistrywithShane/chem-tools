
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chemistry with Shane ‚Äì Stoichiometry Playground</title>
<meta name="color-scheme" content="light only">
<style>
  :root{--brandA:#7c3aed;--brandB:#22d3ee;--ink:#0b1324;--muted:#6b7280;--border:#e5e7eb;--card:#fff;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;}
  body{margin:0;font-family:Inter,system-ui;background:linear-gradient(#f8fafc,#fff);color:var(--ink)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .header{background:linear-gradient(90deg,var(--brandA),var(--brandB));color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px}
  .header .navlinks{margin-left:auto;display:flex;gap:8px}
  .navlinks a{color:#fff;text-decoration:none;font-weight:600;padding:6px 10px;border:1px solid rgba(255,255,255,.25);border-radius:8px}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.two{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.06)}
  .card h2{margin:0;padding:12px;border-bottom:1px dashed var(--border);font-size:18px}
  .card .content{padding:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
  input,button{padding:8px 10px;border:1px solid var(--border);border-radius:8px}
  button{cursor:pointer;font-weight:600}
  button.primary{background:linear-gradient(90deg,var(--brandA),var(--brandB));color:white;border:none}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
  .barwrap{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;height:16px;flex:1}
  .bar{height:100%;background:#60a5fa;transition:width .25s}
  .bar.pink{background:#f472b6}
  .confetti{position:fixed;inset:0;pointer-events:none}
  .mono{font:700 16px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas}
</style>
</head>
<body>
<div class="header">
  <h1>Chemistry with Shane ‚Äì Stoichiometry Playground</h1>
  <div class="navlinks">
    <a href="../">üè† Home</a><a href="../hub/">‚ú® Hub</a><a href="../moles/">üß™ Mole Master</a><a href="../titration/">‚öóÔ∏è Titration</a>
  </div>
</div>
<div class="container grid">

<div class="card"><h2>1) Equation Balancer</h2><div class="content">
  <div class="row">
    <input id="eq" class="mono" value="C3H8 + O2 -> CO2 + H2O" style="flex:1">
    <button class="primary" id="auto-balance">Auto-balance</button>
    <button id="reset-eq">Reset</button>
    <span id="balance-state" class="pill">‚ö† Not balanced</span>
  </div>
  <div id="eq-pretty" class="mono" style="margin-top:8px">‚Äî</div>
  <div class="hint">Try: Fe + O2 -> Fe2O3 ‚Ä¢ KMnO4 -> K2MnO4 + MnO2 + O2 ‚Ä¢ Al + HCl -> AlCl3 + H2</div>
  <canvas id="confetti" class="confetti"></canvas>
</div></div>

<div class="card"><h2>2) Limiting Reactant</h2><div class="content">
  <div class="row"><label>A mass <input id="massA" value="10"></label><label>MrA <input id="MrA" value="32"></label><label>a <input id="coeffA" value="1"></label></div>
  <div class="row"><label>B mass <input id="massB" value="10"></label><label>MrB <input id="MrB" value="2"></label><label>b <input id="coeffB" value="2"></label></div>
  <button class="primary" id="calc-limit">Check</button><span id="limit-out" class="pill">‚Äî</span>
  <div class="row"><span>A</span><div class="barwrap"><div id="barA" class="bar" style="width:50%"></div></div></div>
  <div class="row"><span>B</span><div class="barwrap"><div id="barB" class="bar pink" style="width:50%"></div></div></div>
  <div>Leftover: <span id="leftover">‚Äî</span></div>
</div></div>

<div class="card"><h2>3) % Yield & Atom Economy</h2><div class="content two grid">
  <div><label>Actual <input id="yAct" value="8.5"></label><label>Theoretical <input id="yTheo" value="10"></label><button class="primary" id="calc-yield">Yield</button><span id="yield-out" class="pill">‚Äî</span></div>
  <div><label>Mr desired <input id="MrDesired" value="46"></label><label>Mr total <input id="MrSum" value="60"></label><button class="primary" id="calc-atom">Atom econ</button><span id="atom-out" class="pill">‚Äî</span></div>
</div></div>

<div class="card"><h2>4) Retrieval Deck</h2><div class="content">
  <input type="range" id="ret-dial" min="1" max="6" value="3"><button id="ret-draw">Draw</button><div id="ret-deck"></div>
</div></div>

<div class="card"><h2>5) Particle Picture</h2><div class="content">
  Hover: <span class="mono">2 H2 + O2 ‚Üí 2 H2O</span>
</div></div>

</div>
<script>
const $=q=>document.querySelector(q);

/* ===== Robust equation balancer =====
   - Parses elements with parentheses (e.g., Fe2(SO4)3)
   - Builds element matrix and finds nullspace vector
   - Converts to smallest positive integers
*/
function parseFormula(f){
  // Tokenizer for elements, numbers, parentheses
  let i=0;
  function parseGroup(){
    let counts={};
    while(i<f.length){
      const ch=f[i];
      if(ch==='('){
        i++; const inner=parseGroup();
        if(f[i]!==')') throw new Error('Missing )');
        i++;
        let num=''; while(i<f.length && /\d/.test(f[i])) num+=f[i++];
        const mult = num? parseInt(num,10):1;
        for(const el in inner){ counts[el]=(counts[el]||0)+inner[el]*mult; }
        continue;
      }
      if(ch===')' || ch==='+' || ch==='‚Üí' || ch==='-' || ch==='>'){
        break;
      }
      const m = f.slice(i).match(/^[A-Z][a-z]?/);
      if(!m) break;
      const el = m[0]; i+=el.length;
      let num=''; while(i<f.length && /\d/.test(f[i])) num+=f[i++];
      counts[el]=(counts[el]||0)+(num?parseInt(num,10):1);
    }
    return counts;
  }
  return parseGroup();
}

function splitSides(eq){
  const arrow = eq.includes('->')? '->' : (eq.includes('=>')? '=>' : '‚Üí');
  const [L,R] = eq.split(arrow);
  const left = L.split('+').map(s=>s.trim()).filter(Boolean);
  const right= R.split('+').map(s=>s.trim()).filter(Boolean);
  return {left,right,arrow};
}

function buildMatrix(left,right){
  const species = [...left, ...right];
  const parsed = species.map(x=>parseFormula(x));
  const elemsSet = new Set();
  parsed.forEach(o=>Object.keys(o).forEach(k=>elemsSet.add(k)));
  const elems = Array.from(elemsSet);
  const rows = elems.length, cols = species.length;
  const A = Array.from({length:rows},()=>Array(cols).fill(0));
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const count = parsed[c][elems[r]] || 0;
      A[r][c] = (c<left.length? count : -count);
    }
  }
  return {A, elems, species, leftCount:left.length};
}

function rationalGaussJordan(A){
  // Convert to RREF over rationals
  const rows=A.length, cols=A[0].length;
  // Represent numbers as {n,d} rational (n integer, d>0)
  const make=(n,d=1)=>({n:BigInt(n), d:BigInt(d)});
  const gcd=(a,b)=> b===0n? a: gcd(b, a%b);
  const norm=(x)=>{ if(x.d<0n){ x.n=-x.n; x.d=-x.d; } const g=gcd(x.n<0n?-x.n:x.n, x.d); x.n/=g; x.d/=g; return x; };
  const add=(x,y)=>norm(make(x.n*y.d + y.n*x.d, x.d*y.d));
  const sub=(x,y)=>add(x, make(-y.n,y.d));
  const mul=(x,y)=>norm(make(x.n*y.n, x.d*y.d));
  const div=(x,y)=>norm(make(x.n*y.d, x.d*y.n));
  let M = A.map(row=>row.map(v=>make(v)));
  let r=0;
  for(let c=0;c<cols && r<rows;c++){
    // find pivot
    let piv=r;
    while(piv<rows && M[piv][c].n===0n) piv++;
    if(piv===rows) continue;
    // swap
    [M[r], M[piv]] = [M[piv], M[r]];
    // normalise row r
    const pivval = M[r][c];
    for(let j=c;j<cols;j++) M[r][j] = div(M[r][j], pivval);
    // eliminate others
    for(let i=0;i<rows;i++){
      if(i===r) continue;
      const factor = M[i][c];
      if(factor.n!==0n){
        for(let j=c;j<cols;j++){
          M[i][j] = sub(M[i][j], mul(factor, M[r][j]));
        }
      }
    }
    r++;
  }
  // Extract a nullspace vector by setting free var = 1
  // Identify pivot columns
  const pivotCol = Array(cols).fill(false);
  for(let i=0;i<rows;i++){
    const j = M[i].findIndex(x=>x.n===1n && x.d===1n);
    if(j>=0) pivotCol[j]=True;
  }
  // find a free column
  let free = -1;
  for(let c=cols-1;c>=0;c--) if(!pivotCol[c]){ free=c; break; }
  if(free===-1) free=cols-1; // fallback
  // set free var = 1, solve others
  const sol = Array(cols).fill(make(0));
  sol[free]=make(1);
  for(let i=rows-1;i>=0;i--){
    // find pivot in row
    let piv=-1;
    for(let c=0;c<cols;c++){ if(M[i][c].n===1n and M[i][c].d===1n){ piv=c; break; } }
    if(piv===-1) continue;
    // sum of pivot*sol + ... = 0 -> sol[piv] = -sum(others)
    let s = make(0);
    for(let c=piv+1;c<cols;c++){
      if(M[i][c].n!==0n){
        s = add(s, mul(M[i][c], sol[c]));
      }
    }
    sol[piv] = mul(make(-1), s);
  }
  # convert rationals to ints by lcm of denominators
  def lcm(a,b):
      from math import gcd as _g
      return a*b//_g(a,b)
  denoms = []
  for v in sol:
      denoms.append(int(v['d']))
  L=1
  for d in denoms:
      if d!=0:
          from math import gcd as _g
          L=L*d//_g(L,d)
  ints=[int(v['n'])* (L//int(v['d'])) for v in sol]
  # make positive and reduce gcd
  from math import gcd
  g=0
  for x in ints: g=gcd(g, abs(x))
  if g==0: g=1
  ints=[x//g for x in ints]
  if all(x<=0 for x in ints): ints=[-x for x in ints]
  return ints
}

function balanceEquationGeneral(input){
  // normalise arrows
  let eq = input.replace(/\s+/g,'').replace(/=/g,'->').replace('‚Üí','->');
  if(!eq.includes('->')) return null;
  const {left,right,arrow} = splitSides(eq);
  if(left.length===0 || right.length===0) return null;
  try{
    const {A, species, leftCount} = buildMatrix(left,right);
    const coeffs = rationalGaussJordan(A);
    if(!coeffs) return null;
    const L = species.slice(0,leftCount).map((s,i)=> (coeffs[i]===1?'':coeffs[i]) + s).join(' + ');
    const R = species.slice(leftCount).map((s,i)=> (coeffs[leftCount+i]===1?'':coeffs[leftCount+i]) + s).join(' + ');
    return L + ' ‚Üí ' + R;
  }catch(e){
    return null;
  }
}

function confetti(){
  const cnv=$('#confetti'); const ctx=cnv.getContext('2d');
  cnv.width=window.innerWidth; cnv.height=window.innerHeight;
  const parts=Array.from({length:120},()=>({x:Math.random()*cnv.width,y:-10-Math.random()*200,s:2+Math.random()*3,v:2+Math.random()*3,h:Math.random()*360}));
  let t=0; const tick=()=>{ctx.clearRect(0,0,cnv.width,cnv.height); parts.forEach(p=>{p.y+=p.v; p.x+=Math.sin((p.y+p.h)/20); ctx.fillStyle='hsl('+p.h+',80%,60%)'; ctx.fillRect(p.x,p.y,p.s,p.s*0.6)}); if(t++<90) requestAnimationFrame(tick); else ctx.clearRect(0,0,cnv.width,cnv.height)}; tick();
}

function runBalance(){
  const res = balanceEquationGeneral($('#eq').value);
  if(res){
    $('#eq-pretty').textContent = res;
    $('#balance-state').textContent = '‚úî Balanced';
    confetti();
  }else{
    $('#eq-pretty').textContent = 'Could not balance. Try a simpler equation.';
    $('#balance-state').textContent = '‚ö† Not balanced';
  }
}
$('#auto-balance').onclick=runBalance;
$('#reset-eq').onclick=()=>{$('#eq').value='C3H8 + O2 -> CO2 + H2O'; $('#eq-pretty').textContent='‚Äî'; $('#balance-state').textContent='‚ö† Not balanced';};

/* Limiting */
function calcLimit(){const mA=+$('#massA').value,mB=+$('#massB').value,MrA=+$('#MrA').value,MrB=+$('#MrB').value,a=+$('#coeffA').value,b=+$('#coeffB').value;const nA=mA/MrA,nB=mB/MrB;const rA=nA/a,rB=nB/b;let lim='';if(rA<rB)lim='A';else if(rB<rA)lim='B';else lim='Neither';$('#limit-out').textContent='Limiting: '+lim;const tot=rA+rB||1;$('#barA').style.width=(rA/tot*100)+'%';$('#barB').style.width=(rB/tot*100)+'%';let leftover='‚Äî';if(lim==='A'){leftover=(mB-(nA*a/b)*MrB).toFixed(2)+' g of B';}if(lim==='B'){leftover=(mA-(nB*b/a)*MrA).toFixed(2)+' g of A';}if(lim==='Neither')leftover='0 g';$('#leftover').textContent=leftover;}
$('#calc-limit').onclick=calcLimit; calcLimit();

/* Yield + Atom economy */
$('#calc-yield').onclick=()=>{const a=+$('#yAct').value,t=+$('#yTheo').value;if(t>0){const y=a/t*100;const el=$('#yield-out');el.textContent=y.toFixed(2)+'%';el.style.color=y>=90?'var(--ok)':(y>=50?'var(--warn)':'var(--bad)');}};
$('#calc-atom').onclick=()=>{const d=+$('#MrDesired').value,s=+$('#MrSum').value;if(s>0){const ae=d/s*100;const el=$('#atom-out');el.textContent=ae.toFixed(2)+'%';el.style.color=ae>=80?'var(--ok)':(ae>=50?'var(--warn)':'var(--bad)');}};

/* Retrieval */
const BANK=[{q:'Define limiting reactant.',a:'The reactant used up first; it limits product amount.'},{q:'% yield formula?',a:'(actual/theoretical)√ó100'},{q:'Atom economy formula?',a:'(Mr of desired / total Mr reactants)√ó100'},{q:'One reason yield < 100%?',a:'Side reactions / losses / equilibrium not complete.'},{q:'n from mass?',a:'n = m / Mr'},{q:'Volume at RTP per mol?',a:'‚âà 24 dm¬≥ mol‚Åª¬π'}];
$('#ret-draw').onclick=()=>{const k=+$('#ret-dial').value;const deck=$('#ret-deck');deck.innerHTML='';[...BANK].sort(()=>Math.random()-0.5).slice(0,k).forEach((it,i)=>{const d=document.createElement('details');d.className='card';d.innerHTML='<summary>Q'+(i+1)+'. '+it.q+'</summary><div class="content">'+it.a+'</div>';deck.appendChild(d);});};
</script>
</body></html>
